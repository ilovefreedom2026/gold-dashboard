
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Dashboard Giá Vàng & Bạc — Realtime</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* background layer */
    #bg {
      position: fixed;
      inset: 0;
      z-index: -100;
      background-position: center center;
      background-repeat: no-repeat;
      background-size: cover;
      transition: filter .3s ease, opacity .3s ease;
      will-change: transform, filter;
    }
    /* dark overlay so content remains readable */
    #bg-overlay {
      position: fixed;
      inset: 0;
      z-index: -90;
      pointer-events: none;
      background: rgba(0,0,0,0.25);
      transition: background .2s ease;
    }
    /* settings button & panel */
    .bg-settings-btn {
      position: fixed;
      right: 12px;
      top: 12px;
      z-index: 9999;
      background: rgba(255,255,255,0.95);
      border: 1px solid rgba(0,0,0,0.08);
      padding: 8px;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      font-weight: 700;
    }
    .bg-settings-panel {
      position: fixed;
      right: 12px;
      top: 56px;
      width: 300px;
      max-width: calc(100vw - 24px);
      z-index: 10000;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
      padding: 12px;
      display: none;
      font-family: Inter, Arial, sans-serif;
      font-size: 13px;
    }
    .bg-settings-panel.open { display: block; }
    .bg-settings-panel label { display:block; margin:8px 0 4px; color:#222; font-weight:600; }
    .bg-settings-panel input[type="range"] { width:100%; }
    .bg-settings-panel .row { display:flex; gap:8px; align-items:center; }
    .bg-settings-panel .btn { padding:6px 8px; border-radius:6px; cursor:pointer; border:1px solid #ddd; background:#f8f8f8; }
    .bg-settings-panel .small { font-size:12px; color:#666; }
    /* ensure main content sits above background */
    .app, header, .ticker { position: relative; z-index: 1; }
    /* Responsive tweak */
    @media (max-width:520px){
      .bg-settings-panel { right: 8px; left: 8px; top: 64px; width: auto; }
    }
    :root {
      --gold-1: #F7E0A1;
      --gold-2: #E6C97A;
      --accent: #b8860b;
      --card-border: #E6D3A3;
      --bg: #f4f2ed;
      --unit-font-size: 12px; /* cỡ chữ của "Đơn vị: triệu đồng / Lượng" */
      --bright-yellow: #ffd700; /* vàng sáng */
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: Inter, Arial, Helvetica, sans-serif;
      background: var(--bg);
      color: #111;
    }
    .app {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 12px;
      padding: 12px;
      height: calc(100vh - 48px - 38px);
      margin-top: -10px;
    }
    .left {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-auto-rows: 150px;
      gap: 6px;
      overflow-y: auto;
      padding-right: 6px;
    }
    .right {
      display: flex;
      flex-direction: column;
      gap: 12px;
      height: 100%;
    }
    .chart-box {
      flex: 1 1 60%;
      border-radius: 10px;
      border: 1px solid var(--card-border);
      background: linear-gradient(90deg, var(--gold-1), #fff);
      overflow: hidden;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
    }
    .silver-box {
      flex: 0 0 38%;
      display: grid;
      grid-template-rows: 150px 120px;
      gap: 10px;
    }
    .card {
      width: 100%;
      height: 100%;
      perspective: 1000px;
      position: relative;
      overflow: hidden;
      opacity: 1;
      transition: opacity 0.3s ease;
    }
    .card.hidden {
      opacity: 0;
    }
    .card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transition: transform 0.7s ease;
      transform-style: preserve-3d;
    }
    .card.flipped .card-inner {
      transform: rotateY(180deg);
    }
    .card.shine::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
      animation: shine-effect 1.5s ease-in-out;
      z-index: 2;
    }
    @keyframes shine-effect {
      0% { left: -100%; }
      100% { left: 100%; }
    }
    .card-face {
      position: absolute;
      inset: 0;
      backface-visibility: hidden;
      border-radius: 8px;
      border: 1px solid var(--card-border);
      background: linear-gradient(90deg, var(--gold-1), #fff);
      display: flex;
      padding: 10px;
      gap: 10px;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.06);
    }
    .card-back {
      transform: rotateY(180deg);
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(90deg, var(--gold-1), #fff);
    }
    .logo {
      width: 108px;
      flex: 0 0 108px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 6px;
      background: transparent;
    }
    .logo img {
      max-width: 92px;
      max-height: 92px;
      object-fit: contain;
    }
    .silver-logo {
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 8px;
    }
    .silver-logo img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    .info {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .info-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 30px;
    }
    .info-header.silver-header {
      justify-content: flex-start;
    }
    .brand {
      font-weight: 700;
      color: #ef095d;
      font-size: 24px;
    }
    .unit {
      font-size: 12px;
      color: #444;
      text-align: right;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 15px;
      table-layout: fixed;
    }
    th {
      padding: 6px 8px;
      font-weight: 700;
      color: #222;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }
    td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.04);
      vertical-align: middle;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    td.label {
      font-weight: 700;
      width: 40%;
      color: #222;
    }
    td.buy {
      color: #60886f;
      font-weight: 700;
      text-align: center;
      width: 15%;
      font-size: 19.5px; /* +30% so với 15px */
      line-height: 1;
    }
    td.sell {
      color: #823e44;
      font-weight: 700;
      text-align: center;
      width: 15%;
      font-size: 19.5px; /* +30% */
      line-height: 1;
    }
    td.change {
      width: 15%;
      text-align: center;
      font-weight: 600;
      font-size: 19.5px; /* +30% */
      line-height: 1;
    }
    /* ensure silver/exchange cells inherit same sizing */
    .silver-table td.buy,
    .silver-table td.sell,
    .silver-table td.change,
    .exchange-table td.buy,
    .exchange-table td.sell {
      font-size: 19.5px;
      line-height: 1;
    }
    .silver-table td.label {
      width: 60% !important;
    }
    td.unit {
      text-align: center;
      font-size: 12px;
      color: #444;
    }
    .change-up {
      color: #0b8a3e;
    }
    .change-down {
      color: #c41c2b;
    }
    /* Khi biến động = 0 hoặc chưa có dữ liệu */
    td.change:not(.change-up):not(.change-down) {
    color: #FFD700; /* vàng kim */
    }
    .exchange-table td.label {
      width: 40%;
    }
    .exchange-table td.buy,
    .exchange-table td.sell {
      width: 20%;
    }
    .global-time {
      grid-column: 1 / -1;
      text-align: center;
      font-size: 24px;
      color: #FFD700;
      margin-top: 6px;
    }
    .ticker {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: 48px;
      background: linear-gradient(90deg, #b8860b, #e6c97a);
      color: #fff;
      display: flex;
      align-items: center;
      overflow: hidden;
      font-weight: 700;
      padding-left: 12px;
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.12);
    }
    .ticker .text {
      display: inline-block;
      white-space: nowrap;
      padding-left: 100%;
      animation: scroll 44s linear infinite;
      color: #222 !important;
      font-size: 120%;
    }
    @keyframes scroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }
    .main-title {
      text-align: center;
      padding: 6px 0;
      background: linear-gradient(90deg, var(--gold-2), var(--gold-1));
      color: #a67c00;
      font-size: 24px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      margin: 0;
      text-transform: uppercase;
    }
    .main-title h1 {
      margin: 0;
      position: relative;
      z-index: 1;
      text-shadow: none;
      color: #ef095d;
    }
    .main-title::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      animation: shine 4s linear infinite;
    }
    @keyframes shine {
      0% { left: -100%; }
      50% { left: 100%; }
      100% { left: 100%; }
    }
    .card-face .logo,
    .card-face .info {
      min-height: 120px;
    }
    @media (max-width: 920px) {
      .app {
        grid-template-columns: 1fr;
        height: calc(100vh - 48px - 38px);
        margin-top: -10px;
      }
      .left {
        grid-template-columns: 1fr 1fr;
        grid-auto-rows: 130px;
        gap: 6px;
      }
      .chart-box {
        height: 360px;
      }
      .silver-box {
        grid-template-rows: 130px 100px;
      }
    }
    /* adjust layout styles for dynamic shifting */
    #tradingview-container {
      width: 100%;
      overflow: hidden;
      transition: height 280ms ease;
      box-sizing: border-box;
    }
    .card { position: relative; transition: transform 280ms ease; }
    /* ensure silver/exchange can be moved without breaking flow */
    #card-silver-phuquy, #card-exchange-vcb {
      will-change: transform;
    }
    /* Layout helper: align tradingview and panels to gold grid rows */

    /* Pair zoom CSS: styles for pair-overlay, zoom-clone and zoom background.
       These rules belong inside the main stylesheet so overlay clones inherit fonts
       and don't flash differently during animation. */
    .pair-overlay {
      position: fixed;
      left: 0; top: 0;
      width: 0; height: 0;
      pointer-events: none;
      z-index: 30000;
      overflow: visible;
    }
    .zoom-clone {
      position: absolute;
      box-sizing: border-box;
      transform-origin: center center;
      transition: transform 700ms cubic-bezier(.22,.9,.28,1), opacity 300ms ease;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.24);
      will-change: transform, opacity;
      overflow: hidden;
    }
    .zoom-clone.hidden { opacity: 0; }
    .zoom-bg {
      position: fixed;
      left: 0; top: 0;
      width: 0; height: 0;
      background: rgba(255,255,255,0.06);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      z-index: 29999;
      pointer-events: auto;
      transition: opacity 0.25s;
      opacity: 1;
    }
    .zoom-bg.hidden { opacity: 0; pointer-events: none; }

    /* Hide originals during zoom to avoid ghosts (no layout shift since overlay is positioned before hiding) */
    .card.zoom-hidden { display: none !important; }
  </style>
  <script>
    (function(){
      function getGoldCards() {
        return Array.from(document.querySelectorAll('.gold-card')).filter(Boolean);
      }
      function groupRowsByTop(cards, tol = 6) {
        const rows = [];
        cards.forEach(card => {
          const r = card.getBoundingClientRect();
          const top = Math.round(r.top);
          let placed = false;
          for (const row of rows) {
            if (Math.abs(row.top - top) <= tol) { row.cards.push({card,rect:r}); placed = true; break; }
          }
          if (!placed) rows.push({ top, cards: [{card,rect:r}] });
        });
        rows.sort((a,b)=>a.top-b.top);
        return rows;
      }
      function rowBottom(rows, idx) {
        if (!rows || rows.length === 0) return null;
        const r = rows[Math.min(idx, rows.length-1)];
        let mb = -Infinity;
        r.cards.forEach(x => { mb = Math.max(mb, x.rect.bottom); });
        return mb === -Infinity ? null : mb;
      }
      function adjustLayout() {
        const tradingContainer = document.getElementById('tradingview-container') || document.querySelector('.tradingview-container') ;
        const silverEl = document.getElementById('card-silver-phuquy') || document.querySelector('.card-silver');
        const exchangeEl = document.getElementById('card-exchange-vcb') || document.querySelector('.card-exchange');
        const cards = getGoldCards();
        if (!cards.length || !tradingContainer) return;
        const rows = groupRowsByTop(cards);
        // want bottoms of rows 2,3,4 (index 1,2,3)
        const bottomRow2 = rowBottom(rows, 1);
        const bottomRow3 = rowBottom(rows, 2);
        const bottomRow4 = rowBottom(rows, 3);
        const contRect = tradingContainer.getBoundingClientRect();
        // set trading container height so its bottom == bottomRow2
        if (bottomRow2 && contRect.top < bottomRow2) {
          const desiredH = Math.max(0, Math.round(bottomRow2 - contRect.top));
          tradingContainer.style.height = desiredH + 'px';
          tradingContainer.style.overflow = 'hidden';
        }
        // helper to translate element so its bottom matches targetBottom
        function alignBottom(el, targetBottom) {
          if (!el || !targetBottom) return;
          const r = el.getBoundingClientRect();
          const curBottom = r.bottom;
          const dy = Math.round(targetBottom - curBottom);
          // only translate vertically; preserve possible existing translateX
          const prev = el.style.transform || '';
          // remove previous translateY if set by this code
          const newTransform = (prev.replace(/translateY\([^)]+\)/,'') + ` translateY(${dy}px)`).trim();
          el.style.transform = newTransform;
          el.style.transition = 'transform 260ms ease';
        }
        alignBottom(silverEl, bottomRow3);
        alignBottom(exchangeEl, bottomRow4);
      }
      // run on load, resize and a few delayed ticks (for dynamic content)
      window.addEventListener('load', ()=> { setTimeout(adjustLayout, 100); setTimeout(adjustLayout, 700); } );
      window.addEventListener('resize', ()=> { setTimeout(adjustLayout, 120); } );
      // expose to be called after data render
      window.adjustLayout = adjustLayout;
    })();
  </script>
</head>
<body>
  <div id="bg"></div>
  <div id="bg-overlay"></div>
  <button class="bg-settings-btn" id="bgBtn">⚙️</button>
  <div class="bg-settings-panel" id="bgPanel" aria-hidden="true">
    <label>Chọn ảnh nền (file local)</label>
    <div class="row">
      <input type="file" id="bgFile" accept="image/*" class="btn" />
      <button id="bgClear" class="btn">Xóa</button>
    </div>
    <label>Hoặc dán URL ảnh</label>
    <input id="bgUrl" type="url" placeholder="https://..." />
    <div style="margin-top:8px" class="row">
      <button id="bgUseUrl" class="btn">Sử dụng URL</button>
      <button id="bgSave" class="btn">Save</button>
    </div>
    <label>Size</label>
    <select id="bgSize">
      <option value="cover">Cover</option>
      <option value="contain">Contain</option>
    </select>
    <label>Position</label>
    <select id="bgPos">
      <option value="center center">Center</option>
      <option value="top center">Top</option>
      <option value="bottom center">Bottom</option>
      <option value="left center">Left</option>
      <option value="right center">Right</option>
    </select>
    <label>Blur (px)</label>
    <input id="bgBlur" type="range" min="0" max="20" value="4" />
    <label>Darken overlay (0-0.9)</label>
    <input id="bgDark" type="range" min="0" max="0.9" step="0.05" value="0.25" />
    <div style="margin-top:8px" class="small">Lưu vào localStorage, chỉ hiển thị trên trình duyệt này.</div>
  </div>
  <header class="main-title">
    <h1>Giá vàng trong nước và thế giới ngày <span id="current-date"></span></h1>
  </header>
  <div class="app">
    <div class="left" id="leftGrid">
      <div class="card" id="card-sjc">
        <div class="card-inner">
          <div class="card-face card-front">
            <div class="logo"><img src="https://giavang.org/assets/images/gia-vang/logo-sjc.png" alt="SJC"></div>
            <div class="info">
              <div class="info-header">
                <div class="brand">SJC</div>
                <div class="unit">Đơn vị: triệu đồng / Lượng</div>
              </div>
              <table>
                <tr><th class="label"></th><th>Mua vào</th><th>Bán ra</th><th>Biến động</th></tr>
                <tr><td class="label">Vàng Miếng</td><td class="buy" id="sjc-mieng-buy">-</td><td class="sell" id="sjc-mieng-sell">-</td><td class="change" id="sjc-mieng-change">-</td></tr>
                <tr><td class="label">Vàng Nhẫn</td><td class="buy" id="sjc-nhan-buy">-</td><td class="sell" id="sjc-nhan-sell">-</td><td class="change" id="sjc-nhan-change">-</td></tr>
              </table>
            </div>
          </div>
          <div class="card-face card-back">
            <img src="https://giavang.org/assets/images/gia-vang/logo-sjc.png" alt="logo">
          </div>
        </div>
      </div>
      <div class="card" id="card-doji">
        <div class="card-inner">
          <div class="card-face card-front">
            <div class="logo"><img src="https://giavang.org/assets/images/gia-vang/logo-doji.png" alt="DOJI"></div>
            <div class="info">
              <div class="info-header">
                <div class="brand">DOJI</div>
                <div class="unit">Đơn vị: triệu đồng / Lượng</div>
              </div>
              <table>
                <tr><th class="label"></th><th>Mua vào</th><th>Bán ra</th><th>Biến động</th></tr>
                <tr><td class="label">Vàng Miếng</td><td class="buy" id="doji-mieng-buy">-</td><td class="sell" id="doji-mieng-sell">-</td><td class="change" id="doji-mieng-change">-</td></tr>
                <tr><td class="label">Vàng Nhẫn</td><td class="buy" id="doji-nhan-buy">-</td><td class="sell" id="doji-nhan-sell">-</td><td class="change" id="doji-nhan-change">-</td></tr>
              </table>
            </div>
          </div>
          <div class="card-face card-back"><img src="https://giavang.org/assets/images/gia-vang/logo-doji.png" alt="logo"></div>
        </div>
      </div>
      <div class="card" id="card-pnj">
        <div class="card-inner">
          <div class="card-face card-front">
            <div class="logo"><img src="https://giavang.org/assets/images/gia-vang/logo-pnj.png" alt="PNJ"></div>
            <div class="info">
              <div class="info-header">
                <div class="brand">PNJ</div>
                <div class="unit">Đơn vị: triệu đồng / Lượng</div>
              </div>
              <table>
                <tr><th class="label"></th><th>Mua vào</th><th>Bán ra</th><th>Biến động</th></tr>
                <tr><td class="label">Vàng Miếng</td><td class="buy" id="pnj-mieng-buy">-</td><td class="sell" id="pnj-mieng-sell">-</td><td class="change" id="pnj-mieng-change">-</td></tr>
                <tr><td class="label">Vàng Nhẫn</td><td class="buy" id="pnj-nhan-buy">-</td><td class="sell" id="pnj-nhan-sell">-</td><td class="change" id="pnj-nhan-change">-</td></tr>
              </table>
            </div>
          </div>
          <div class="card-face card-back"><img src="https://giavang.org/assets/images/gia-vang/logo-pnj.png" alt="logo"></div>
        </div>
      </div>
      <div class="card" id="card-btmc">
        <div class="card-inner">
          <div class="card-face card-front">
            <div class="logo"><img src="https://giavang.org/assets/images/gia-vang/logo-bao-tin-minh-chau.png" alt="BTMC"></div>
            <div class="info">
              <div class="info-header">
                <div class="brand">Bảo Tín Minh Châu</div>
                <div class="unit">Đơn vị: triệu đồng / Lượng</div>
              </div>
              <table>
                <tr><th class="label"></th><th>Mua vào</th><th>Bán ra</th><th>Biến động</th></tr>
                <tr><td class="label">Vàng Miếng</td><td class="buy" id="btmc-mieng-buy">-</td><td class="sell" id="btmc-mieng-sell">-</td><td class="change" id="btmc-mieng-change">-</td></tr>
                <tr><td class="label">Vàng Nhẫn</td><td class="buy" id="btmc-nhan-buy">-</td><td class="sell" id="btmc-nhan-sell">-</td><td class="change" id="btmc-nhan-change">-</td></tr>
              </table>
            </div>
          </div>
          <div class="card-face card-back"><img src="https://giavang.org/assets/images/gia-vang/logo-bao-tin-minh-chau.png" alt="logo"></div>
        </div>
      </div>
      <div class="card" id="card-btmh">
        <div class="card-inner">
          <div class="card-face card-front">
            <div class="logo"><img src="https://giavang.org/assets/images/gia-vang/logo-bao-tin-manh-hai.png" alt="BT Mạnh Hải"></div>
            <div class="info">
              <div class="info-header">
                <div class="brand">Bảo Tín Mạnh Hải</div>
                <div class="unit">Đơn vị: triệu đồng / Lượng</div>
              </div>
              <table>
                <tr><th class="label"></th><th>Mua vào</th><th>Bán ra</th><th>Biến động</th></tr>
                <tr><td class="label">Vàng Miếng</td><td class="buy" id="btmh-mieng-buy">-</td><td class="sell" id="btmh-mieng-sell">-</td><td class="change" id="btmh-mieng-change">-</td></tr>
                <tr><td class="label">Vàng Nhẫn</td><td class="buy" id="btmh-nhan-buy">-</td><td class="sell" id="btmh-nhan-sell">-</td><td class="change" id="btmh-nhan-change">-</td></tr>
              </table>
            </div>
          </div>
          <div class="card-face card-back"><img src="https://giavang.org/assets/images/gia-vang/logo-bao-tin-manh-hai.png" alt="logo"></div>
        </div>
      </div>
      <div class="card" id="card-phuquy">
        <div class="card-inner">
          <div class="card-face card-front">
            <div class="logo"><img src="https://giavang.org/assets/images/gia-vang/logo-phu-quy.png" alt="Phú Quý"></div>
            <div class="info">
              <div class="info-header">
                <div class="brand">Phú Quý</div>
                <div class="unit">Đơn vị: triệu đồng / Lượng</div>
              </div>
              <table>
                <tr><th class="label"></th><th>Mua vào</th><th>Bán ra</th><th>Biến động</th></tr>
                <tr><td class="label">Vàng Miếng</td><td class="buy" id="phuquy-mieng-buy">-</td><td class="sell" id="phuquy-mieng-sell">-</td><td class="change" id="phuquy-mieng-change">-</td></tr>
                <tr><td class="label">Vàng Nhẫn</td><td class="buy" id="phuquy-nhan-buy">-</td><td class="sell" id="phuquy-nhan-sell">-</td><td class="change" id="phuquy-nhan-change">-</td></tr>
              </table>
            </div>
          </div>
          <div class="card-face card-back"><img src="https://giavang.org/assets/images/gia-vang/logo-phu-quy.png" alt="logo"></div>
        </div>
      </div>
      <div class="card" id="card-mihong">
        <div class="card-inner">
          <div class="card-face card-front">
            <div class="logo"><img src="https://giavang.org/assets/images/gia-vang/logo-mi-hong.png" alt="Mi Hồng"></div>
            <div class="info">
              <div class="info-header">
                <div class="brand">Mi Hồng</div>
                <div class="unit">Đơn vị: triệu đồng / Lượng</div>
              </div>
              <table>
                <tr><th class="label"></th><th>Mua vào</th><th>Bán ra</th><th>Biến động</th></tr>
                <tr><td class="label">Vàng Miếng</td><td class="buy" id="mihong-mieng-buy">-</td><td class="sell" id="mihong-mieng-sell">-</td><td class="change" id="mihong-mieng-change">-</td></tr>
                <tr><td class="label">Vàng Nhẫn</td><td class="buy" id="mihong-nhan-buy">-</td><td class="sell" id="mihong-nhan-sell">-</td><td class="change" id="mihong-nhan-change">-</td></tr>
              </table>
            </div>
          </div>
          <div class="card-face card-back"><img src="https://giavang.org/assets/images/gia-vang/logo-mi-hong.png" alt="logo"></div>
        </div>
      </div>
      <div class="card" id="card-ngoctham">
        <div class="card-inner">
          <div class="card-face card-front">
            <div class="logo"><img src="https://giavang.org/assets/images/gia-vang/logo-ngoc-tham.png" alt="Ngọc Thẩm"></div>
            <div class="info">
              <div class="info-header">
                <div class="brand">Ngọc Thẩm</div>
                <div class="unit">Đơn vị: triệu đồng / Lượng</div>
              </div>
              <table>
                <tr><th class="label"></th><th>Mua vào</th><th>Bán ra</th><th>Biến động</th></tr>
                <tr><td class="label">Vàng Miếng</td><td class="buy" id="ngoctham-mieng-buy">-</td><td class="sell" id="ngoctham-mieng-sell">-</td><td class="change" id="ngoctham-mieng-change">-</td></tr>
                <tr><td class="label">Vàng Nhẫn</td><td class="buy" id="ngoctham-nhan-buy">-</td><td class="sell" id="ngoctham-nhan-sell">-</td><td class="change" id="ngoctham-nhan-change">-</td></tr>
              </table>
            </div>
          </div>
          <div class="card-face card-back"><img src="https://giavang.org/assets/images/gia-vang/logo-ngoc-tham.png" alt="logo"></div>
        </div>
      </div>
      <div class="global-time" id="global-time">—</div>
    </div>
    <div class="right">
      <div class="chart-box" id="tv-box">
        <div id="tradingview_chart" style="width:100%;height:100%"></div>
        <!-- target for details panel moved here -->
        <div id="tradingview_detail_target" style="position:absolute; top:8px; right:8px; width:320px; max-height:92%; overflow:auto; z-index:40; pointer-events:auto;"></div>
      </div>
      <div class="silver-box">
        <div class="card" id="card-silver-phuquy">
          <div class="card-inner">
            <div class="card-face card-front">
              <div class="info">
                <div class="info-header silver-header">
                  <div class="silver-logo"><img src="https://giavang.org/assets/images/gia-vang/logo-phu-quy.png" alt="Phú Quý"></div>
                  <div class="brand">Bạc Phú Quý</div>
                </div>
                <table class="silver-table">
                  <tr><th class="label"></th><th>Mua vào</th><th>Bán ra</th><th>Đơn vị</th><th>Biến động</th></tr>
                  <tr><td class="label">Bạc Miếng 999 1 Lượng</td><td class="buy" id="silver-mieng-buy">-</td><td class="sell" id="silver-mieng-sell">-</td><td class="unit">triệu / Lượng</td><td class="change" id="silver-mieng-change">-</td></tr>
                  <tr><td class="label">Bạc Thỏi 999 1Kg</td><td class="buy" id="silver-thoi-buy">-</td><td class="sell" id="silver-thoi-sell">-</td><td class="unit">triệu / Kg</td><td class="change" id="silver-thoi-change">-</td></tr>
                </table>
              </div>
            </div>
            <div class="card-face card-back"><img src="https://giavang.org/assets/images/gia-vang/logo-phu-quy.png" alt="logo"></div>
          </div>
        </div>
        <div class="card" id="card-exchange-vcb">
          <div class="card-inner">
            <div class="card-face card-front">
              <div class="info">
                <div class="info-header">
                  <div class="brand">Tỷ giá USD/VND Vietcombank</div>
                </div>
                <table class="exchange-table">
                  <tr><th class="label"></th><th>Mua tiền mặt (VNĐ)</th><th>Mua chuyển khoản (VNĐ)</th><th>Bán ra (VNĐ)</th></tr>
                  <tr><td class="label">1 USD</td><td class="buy" id="exchange-mua-cash">-</td><td class="buy" id="exchange-mua-transfer">-</td><td class="sell" id="exchange-ban-ra">-</td></tr>
                </table>
              </div>
            </div>
            <div class="card-face card-back"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="ticker"><div class="text">XIN CHÀO MỌI NGƯỜI, CẢM ƠN MỌI NGƯỜI ĐÃ GHÉ THĂM KÊNH CẬP NHẬT GIÁ VÀNG, GIÁ BẠC TRONG NƯỚC. RẤT MONG NHẬN ĐƯỢC SỰ ỦNG HỘ CỦA MỌI NGƯỜI. NẾU THẤY KÊNH HỮU ÍCH HÃY CHO EM XIN MỘT NÚT LIKE CHO KÊNH, NHẤN ĐĂNG KÝ ĐỂ MỖI KHI MỌI NGƯỜI ONLINE CÓ THỂ NHẬN ĐƯỢC THÔNG TIN GIÁ VÀNG, BẠC CẬP NHẬT MỚI VÀ TIỆN LỢI NHẤT. RẤT MONG NHẬN ĐƯỢC NHỮNG ĐÓNG GÓP Ý KIẾN, NHẬN ĐỊNH, THẢO LUẬN VỀ XU HƯỚNG CỦA MỌI NGƯỜI ĐỂ CHÚNG TA CÙNG NHAU ĐẦU TƯ HIỆU QUẢ...XIN CẢM ƠN MỌI NGƯỜI</div></div>
  <script src="https://s3.tradingview.com/tv.js"></script>
  <script>
    // existing widget init
    new TradingView.widget({
      "container_id": "tradingview_chart",
      "width": "100%",
      "height": "100%",
      "symbol": "OANDA:XAUUSD",
      "interval": "D",
      "timezone": "Asia/Ho_Chi_Minh",
      "theme": "light",
      "style": "1",
      "locale": "vi",
      "toolbar_bg": "#f1f1f1",
      "enable_publishing": false,
      "allow_symbol_change": true,
      "details": true,
      "hide_side_toolbar": false,
      "studies": ["MASimple@tv-basicstudies"],
      "withdateranges": true,
      "show_popup_button": true,
      "hotlist": true,
      "calendar": true
    });
    // Move details-panel from widget into right-top of chart when available.
    (function moveDetailsPanelWithFallback() {
      const target = document.getElementById('tradingview_detail_target');
      if (!target) return console.warn('detail target not found (no #tradingview_detail_target)');
      let originalParent = null;
      let originalNext = null;
      let attempts = 0;
      const maxAttempts = 20;
      let fallbackApplied = false;
      function tryMove() {
        const selector = '[data-test-id-widget-type="detail"], .widgetbar-widget-detail, .widgetbar-widget[data-test-id-widget-type="detail"]';
        const src = document.querySelector('#tradingview_chart ' + selector) || document.querySelector('.tradingview-widget-container ' + selector) || document.querySelector(selector);
        if (!src) return false;
        if (!originalParent) { originalParent = src.parentNode; originalNext = src.nextSibling; }
        try {
          target.appendChild(src);
          src.style.position = 'relative';
          src.style.width = '100%';
          src.style.boxSizing = 'border-box';
          src.style.maxHeight = '100%';
          src.style.overflow = 'auto';
          addRestoreButton();
          console.log('detail widget moved into #tradingview_detail_target');
          return true;
        } catch (e) {
          console.warn('moveDetailsPanel error', e && e.message);
          return false;
        }
      }
      function addRestoreButton() {
        if (document.getElementById('tv-detail-restore-btn')) return;
        const btn = document.createElement('button');
        btn.id = 'tv-detail-restore-btn';
        btn.textContent = 'Restore Details';
        btn.style.position = 'absolute';
        btn.style.top = '6px';
        btn.style.left = '6px';
        btn.style.zIndex = '120';
        btn.style.padding = '6px 8px';
        btn.style.fontWeight = '700';
        btn.onclick = restore;
        target.appendChild(btn);
      }
      function restore() {
        const sel = target.querySelector('[data-test-id-widget-type="detail"], .widgetbar-widget-detail, .widgetbar-widget[data-test-id-widget-type="detail"]');
        if (!sel) return console.warn('no detail widget to restore');
        if (originalParent) {
          if (originalNext) originalParent.insertBefore(sel, originalNext);
          else originalParent.appendChild(sel);
          const b = document.getElementById('tv-detail-restore-btn');
          if (b && b.parentNode) b.parentNode.removeChild(b);
          sel.style.position = '';
          sel.style.width = '';
          sel.style.boxSizing = '';
          sel.style.maxHeight = '';
          sel.style.overflow = '';
          console.log('detail widget restored to original position');
        } else {
          console.warn('original parent unknown; not restored');
        }
      }
      function applyFallback() {
        if (fallbackApplied) return;
        fallbackApplied = true;
        console.warn('TradingView detail not found — applying fallback: restore trading view size and overlay silver/exchange cards.');
        // restore trading container sizing (undo any script-set height/maxHeight)
        const restoreSelectors = ['#tradingview-container', '#tv-box', '.tradingview-widget-container', '.chart-box'];
        restoreSelectors.forEach(s => {
          const el = document.querySelector(s);
          if (!el) return;
          el.style.height = '';
          el.style.maxHeight = '';
          el.style.overflow = '';
          // push trading box behind overlay cards
          el.style.zIndex = '1';
        });
        // force silver / exchange cards to render above TradingView (overlay)
        ['card-silver-phuquy', 'card-exchange-vcb'].forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          el.style.position = 'relative';
          el.style.zIndex = '100';
          // ensure pointer interactions still work
          el.style.pointerEvents = 'auto';
          // optional visual tweak so overlay stands out
          el.style.boxShadow = '0 8px 20px rgba(0,0,0,0.12)';
          el.style.background = el.style.background || window.getComputedStyle(el).backgroundColor || 'rgba(255,255,255,0.9)';
        });
      }
      const id = setInterval(() => {
        attempts++;
        const ok = tryMove();
        if (ok) {
          clearInterval(id);
        } else if (attempts >= maxAttempts) {
          clearInterval(id);
          applyFallback();
        }
      }, 500);
    })();
  </script>
  <script>
    const dateEl = document.getElementById('current-date');
    if (dateEl) {
      const today = new Date();
      const dd = String(today.getDate()).padStart(2, '0');
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const yyyy = today.getFullYear();
      dateEl.textContent = `${dd}/${mm}/${yyyy}`;
    }
    const cardIds = ['card-sjc','card-doji','card-pnj','card-btmc','card-btmh','card-phuquy','card-mihong','card-ngoctham','card-silver-phuquy','card-exchange-vcb'];
    const goldCardIds = cardIds.slice(0, 8);
    const silverAndExchangeIds = cardIds.slice(8);
    const PROXY_URL = 'http://localhost:3000/scrape';
    // Helpers: parse numbers returned by server which may be numbers or strings like "138.100" or "-"
    function parseNumberFromServer(v) {
      if (v === undefined || v === null) return undefined;
      if (typeof v === 'number') return v;
      if (typeof v === 'string') {
        const s = v.trim();
        if (s === '-' || s === '') return undefined;
        // keep dot or comma as decimal separator; normalize comma->dot and remove non-digits
        const cleaned = s.replace(/[^0-9.,-]/g, '').replace(/,/g, '.');
        const n = parseFloat(cleaned);
        return Number.isFinite(n) ? n : undefined;
      }
      return undefined;
    }
    function formatMaybeNumber(v) {
      const n = parseNumberFromServer(v);
      return n === undefined ? '-' : n.toFixed(3);
    }
    function formatSilverValue(v) {
      const n = parseNumberFromServer(v);
      return n === undefined ? '-' : (n / 1000000).toFixed(3);
    }
    // Format change values consistently: return absolute string with 3 decimals
    function formatChangeTo3(raw) {
      if (raw == null || raw === '-') return '-';
      const s = String(raw).trim();
      // remove leading sign for formatting
      const numPart = (s[0] === '+' || s[0] === '-') ? s.slice(1) : s;
      const cleaned = numPart.replace(/[^0-9.,]/g, '').replace(/,/g, '.');
      const n = Number(cleaned);
      if (Number.isNaN(n)) return '-';
      return n.toFixed(3);
    }
    function changeSign(raw) {
      if (raw == null || raw === '-') return 0;
      const s = String(raw).trim();
      if (s[0] === '+') return 1;
      if (s[0] === '-') return -1;
      const n = Number(s.replace(/[^0-9.,-]/g,'').replace(/,/g,'.'));
      if (Number.isNaN(n)) return 0;
      return n > 0 ? 1 : (n < 0 ? -1 : 0);
    }
    // Initial reveal to show '-' values
    function initialReveal() {
      cardIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.classList.remove('flipped', 'hidden', 'shine');
          const buys = el.querySelectorAll('td.buy');
          const sells = el.querySelectorAll('td.sell');
          const changes = el.querySelectorAll('td.change');
          buys.forEach(td => td.textContent = '-');
          sells.forEach(td => td.textContent = '-');
          changes.forEach(td => td.textContent = '-');
        }
      });
      const globalTimeEl = document.getElementById('global-time');
      if (globalTimeEl) globalTimeEl.textContent = 'Cập nhật: -';
    }
    initialReveal();
    function flipToLogo() {
      // only flip gold cards — silver & exchange must NOT flip
      goldCardIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.add('flipped');
      });
    }
    function hideAll() {
      // Only hide the 8 gold cards. Silver + Exchange must remain visible (no flip/hidden).
      goldCardIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.classList.remove('flipped');
          el.classList.add('hidden');
        }
      });
      // Ensure silver & exchange stay visible and do not get flipped
      silverAndExchangeIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.classList.remove('hidden');
          el.classList.remove('flipped');
        }
      });
    }
    function revealWithShine(cardEl, updates, delay) {
      setTimeout(() => {
        cardEl.classList.remove('hidden');
        cardEl.classList.add('shine');
        setTimeout(() => {
          const buys = cardEl.querySelectorAll('td.buy');
          const sells = cardEl.querySelectorAll('td.sell');
          const changes = cardEl.querySelectorAll('td.change');
          if (updates.rows) {
            updates.rows.forEach((row, idx) => {
              if (buys[idx]) buys[idx].textContent = row.buy || '-';
              if (row.buyTransfer && buys[idx + 1]) buys[idx + 1].textContent = row.buyTransfer || '-';
              if (sells[idx]) sells[idx].textContent = row.sell || '-';
              if (changes[idx] && row.change !== undefined) {
                const sign = changeSign(row.change);
                const formatted = formatChangeTo3(row.change);
                if (formatted === '-') {
                  changes[idx].textContent = '-';
                  changes[idx].className = 'change';
                } else {
                  changes[idx].textContent = (sign > 0 ? '▲ ' : (sign < 0 ? '▼ ' : '')) + formatted;
                if (sign > 0) {
            // Khi giá tăng
            changes[idx].removeAttribute("style"); // Xóa màu cũ (vàng) nếu có
           changes[idx].className = 'change change-up';
          } else if (sign < 0) {
           // Khi giá giảm
            changes[idx].removeAttribute("style"); // Xóa màu cũ (vàng) nếu có
            changes[idx].className = 'change change-down';
            } else {
          // Khi bằng 0 hoặc chưa có biến động
            changes[idx].className = 'change';
               changes[idx].style.color = '#ceb10a'; // vàng kim khi chưa có biến động
                 }

                }
              }
            });
          }
          const globalTimeEl = document.getElementById('global-time');
          if (globalTimeEl) globalTimeEl.textContent = `Cập nhật: ${updates.update_time || '-'}`;
        }, 380);
        setTimeout(() => cardEl.classList.remove('shine'), 1500);
      }, delay);
    }
    async function fetchRealUpdate() {
      try {
        console.log('Attempting to fetch from', PROXY_URL);
        const response = await fetch(PROXY_URL, { method: 'GET', headers: { 'Accept': 'application/json' }, mode: 'cors' });
        if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        const data = await response.json();
        console.log('Fetched data:', data);
        flipToLogo();
        setTimeout(hideAll, 700);
        const delays = [0, 500, 1000, 1500, 2000, 2500, 3000, 3500];
        goldCardIds.forEach((id, index) => {
          const el = document.getElementById(id);
          if (!el) return;
          const brandKey = id.replace('card-', '').toUpperCase();
          const brandData = data.gold?.[brandKey] || {};
          revealWithShine(el, {
            update_time: data.gold?.update_time || '-',
            // pass raw change strings from backend; formatting happens in revealWithShine
            rows: [
              { buy: formatMaybeNumber(brandData.mieng_buy), sell: formatMaybeNumber(brandData.mieng_sell), change: brandData.mieng_buy_change },
              { buy: formatMaybeNumber(brandData.nhan_buy), sell: formatMaybeNumber(brandData.nhan_sell), change: brandData.nhan_buy_change }
            ]
          }, 1000 + delays[index]);
        });
        const silverEl = document.getElementById('card-silver-phuquy');
        if (silverEl && data.silver?.phuquy) {
          revealWithShine(silverEl, {
            update_time: data.silver?.update_time || '-',
            rows: [
              { buy: formatSilverValue(data.silver.phuquy.mieng_buy), sell: formatSilverValue(data.silver.phuquy.mieng_sell), change: data.silver.phuquy.mieng_buy_change },
              { buy: formatSilverValue(data.silver.phuquy.thoi_buy), sell: formatSilverValue(data.silver.phuquy.thoi_sell), change: data.silver.phuquy.thoi_buy_change }
            ]
          }, 1000 + 1600);
        } else if (silverEl) {
          revealWithShine(silverEl, {
            update_time: data.silver?.update_time || '-',
            rows: [
              { buy: '-', sell: '-', change: 0 },
              { buy: '-', sell: '-', change: 0 }
            ]
          }, 1000 + 1600);
        }
        const exchangeEl = document.getElementById('card-exchange-vcb');
        if (exchangeEl && data.exchange?.vcb) {
          revealWithShine(exchangeEl, {
            update_time: data.exchange?.update_time || '-',
            rows: [{ buy: data.exchange.vcb.mua_cash || '-', buyTransfer: data.exchange.vcb.mua_transfer || '-', sell: data.exchange.vcb.ban_ra || '' } ]
          }, 1000 + 1800);
        } else if (exchangeEl) {
          revealWithShine(exchangeEl, {
            update_time: data.exchange?.update_time || '-',
            rows: [{ buy: '-', buyTransfer: '-', sell: '-' } ]
          }, 1000 + 1800);
        }
        // ensure global time updated once
        (function updateGlobalTime() {
          const globalTimeEl = document.getElementById('global-time');
          if (!globalTimeEl) return;
          const src = data.gold?.update_time_source || data.silver?.update_time_source || data.exchange?.update_time_source || null;
          const local = data.gold?.update_time_local || data.silver?.update_time_local || data.exchange?.update_time_local || data.gold?.update_time || data.silver?.update_time || data.exchange?.update_time || '-';
          if (src && src !== '-' && src !== local) {
            globalTimeEl.textContent = `Cập nhật: ${local} (nguồn: ${src})`;
          } else {
            globalTimeEl.textContent = `Cập nhật: ${local || src || '-'}`;
          }
        })();
        // run layout adjustment after DOM updates and reveal transitions complete
        // delays: gold reveals finish ~1000 + max(delays) + internal timeout 380 -> safe wait 1800ms
        setTimeout(() => { if (window.adjustLayout) window.adjustLayout(); }, 2000);
      } catch (error) {
        console.error('Fetch error details:', error);
        // Reveal with fallback
        const delays = [0, 200, 400, 600, 800, 1000, 1200, 1400, 1600, 1800];
        cardIds.forEach((id, index) => {
          const el = document.getElementById(id);
          if (el) {
            revealWithShine(el, {
              update_time: '-',
              rows: [{ buy: '-', sell: '-', change: 0 }, { buy: '-', sell: '-', change: 0 }]
            }, 500 + delays[index]);
          }
        });
        // still try to adjust layout
        setTimeout(() => { if (window.adjustLayout) window.adjustLayout(); }, 1200);
      }
    }
    setInterval(fetchRealUpdate, 90000);
    fetchRealUpdate();
    // Ticker: fetch /ticker and update scrolling text
    async function fetchTicker() {
      try {
        const res = await fetch('http://localhost:3000/ticker');
        if (!res.ok) throw new Error('Ticker fetch failed');
        const j = await res.json();
        if (!j.success) throw new Error('Ticker response not success');
        const parts = [];
  // VN indices (format: SYMBOL value change (pct))
  (j.vn_indices || []).forEach(idx => parts.push(`${idx.name} ${idx.value_str || '-'} ${idx.change_str === '-' ? '-' : idx.change_str + ' (' + (idx.change_pct_str || '-') + ')'}`));
  // Fuels (same format)
  (j.fuels || []).forEach(f => parts.push(`${f.name} ${f.value_str || '-'} ${f.change_str === '-' ? '-' : f.change_str + ' (' + (f.change_pct_str || '-') + ')'}`));
        // Cryptos
        (j.cryptos || []).forEach(c => parts.push(`${c.symbol} ${(c.change_pct === '-' ? '-' : (c.change_pct >= 0 ? '+' : '') + c.change_pct.toFixed(2) + '%')}`));
        const tickerEl = document.querySelector('.ticker .text');
        if (tickerEl) tickerEl.textContent = parts.join(' | ');
      } catch (err) {
        console.error('Ticker error:', err);
      }
    }
    fetchTicker();
    setInterval(fetchTicker, 60000);
  </script>
  <!-- preserve existing layout: ensure containers can be resized by script -->
  <style>
    #tv-box, #tradingview-container, .tradingview-widget-container, .chart-box {
      transition: height 260ms ease;
      overflow: hidden;
      max-height: none;
    }
    /* allow transform on cards */
    #card-silver-phuquy, #card-exchange-vcb {
      transition: transform 260ms ease;
      will-change: transform;
    }
  </style>
  <!-- existing DOM should remain; script below will operate on existing elements -->
  <script>
    (function () {
      const TRADING_SELECTORS = ['#tv-box', '#tradingview-container', '.tradingview-widget-container', '.chart-box', 'iframe.tradingview'];
      const LEFTGRID_ID = 'leftGrid';
      const SILVER_ID = 'card-silver-phuquy';
      const EXCHANGE_ID = 'card-exchange-vcb';
      function findTradingContainer() {
        for (const s of TRADING_SELECTORS) {
          const el = document.querySelector(s);
          if (el) return el;
        }
        return null;
      }
      function getGoldCardsFromLeftGrid() {
        const left = document.getElementById(LEFTGRID_ID);
        if (!left) return [];
        return Array.from(left.querySelectorAll(':scope > .card')).filter(c => c && c.id && c.id !== SILVER_ID && c.id !== EXCHANGE_ID);
      }
      function groupRowsByTop(cards, tol = 8) {
        const rows = [];
        cards.forEach(card => {
          const r = card.getBoundingClientRect();
          const top = Math.round(r.top);
          let row = rows.find(x => Math.abs(x.top - top) <= tol);
          if (!row) { row = { top, rects: [] }; rows.push(row); }
          row.rects.push(r);
        });
        rows.sort((a,b) => a.top - b.top);
        return rows;
      }
      function setTranslateY(el, dy) {
        if (!el) return;
        const prev = el.style.transform || '';
        const cleaned = prev.replace(/translateY\([^)]+\)/, '').trim();
        el.style.transform = (cleaned + ` translateY(${dy}px)`).trim();
        el.style.transition = 'transform 260ms ease';
      }
      // New behaviour:
      // - DO NOT change trading view height.
      // - Move silver so its bottom aligns with trading view bottom.
      // - Resize & move exchange so its TOP aligns with top of gold row 4 and its height matches that row.
      function adjustTradingLayout() {
        const trading = findTradingContainer();
        const goldCards = getGoldCardsFromLeftGrid();
        if (!trading || !goldCards.length) return false;
        const rows = groupRowsByTop(goldCards, 8);
        const row3 = rows[2]; // index 2 -> 3rd row (reference for silver)
        const row4 = rows[3]; // keep row4 for exchange fallback/behavior
        const silver = document.getElementById(SILVER_ID);
        const exchange = document.getElementById(EXCHANGE_ID);
        // SILVER: align TOP to top of gold row 3 and BOTTOM to bottom of gold row 3
        if (silver && row3 && row3.rects && row3.rects.length) {
          const topRow3 = Math.min(...row3.rects.map(r => r.top));
          const bottomRow3 = Math.max(...row3.rects.map(r => r.bottom));
          const heightRow3 = Math.max(36, Math.round(bottomRow3 - topRow3));
          // set explicit height to match row 3, then translate so top aligns
          silver.style.boxSizing = 'border-box';
          silver.style.height = heightRow3 + 'px';
          if (window.getComputedStyle(silver).position === 'static') silver.style.position = 'relative';
          silver.style.zIndex = '120';
          // measure then move so top == topRow3 (matching both top and bottom because height matches)
          const sRect = silver.getBoundingClientRect();
          const dy = Math.round(topRow3 - sRect.top);
          setTranslateY(silver, dy);
        } else if (silver) {
          // fallback: keep previous behavior (align bottom with trading bottom)
          const tradingRect = trading.getBoundingClientRect();
          const tradingBottom = tradingRect.bottom;
          const sRect = silver.getBoundingClientRect();
          const dy = Math.round(tradingBottom - sRect.bottom);
          if (window.getComputedStyle(silver).position === 'static') silver.style.position = 'relative';
          silver.style.zIndex = '120';
          setTranslateY(silver, dy);
        }
        // EXCHANGE: unchanged from prior logic — try to align top to row 4 and size to match row4 height
        if (exchange) {
          if (row4 && row4.rects && row4.rects.length) {
            const topRow4 = Math.min(...row4.rects.map(r => r.top));
            const bottomRow4 = Math.max(...row4.rects.map(r => r.bottom));
            const heightRow4 = Math.max(36, Math.round(bottomRow4 - topRow4));
            exchange.style.boxSizing = 'border-box';
            exchange.style.height = heightRow4 + 'px';
            if (window.getComputedStyle(exchange).position === 'static') exchange.style.position = 'relative';
            exchange.style.zIndex = '120';
            const eRect = exchange.getBoundingClientRect();
            const dy = Math.round(topRow4 - eRect.top);
            setTranslateY(exchange, dy);
          } else {
            // fallback: no row4 available -> align to trading bottom
            const tradingRect = trading.getBoundingClientRect();
            const tradingBottom = tradingRect.bottom;
            const eRect = exchange.getBoundingClientRect();
            const dy = Math.round(tradingBottom - eRect.bottom);
            if (window.getComputedStyle(exchange).position === 'static') exchange.style.position = 'relative';
            exchange.style.zIndex = '120';
            setTranslateY(exchange, dy);
          }
        }
        return true;
      }
      window.adjustTradingLayout = adjustTradingLayout;
      window.addEventListener('load', () => {
        setTimeout(adjustTradingLayout, 200);
        setTimeout(adjustTradingLayout, 800);
        setTimeout(adjustTradingLayout, 1600);
      });
      window.addEventListener('resize', () => { setTimeout(adjustTradingLayout, 140); });
      if (window.fetchRealUpdate && typeof window.fetchRealUpdate === 'function') {
        const orig = window.fetchRealUpdate;
        window.fetchRealUpdate = async function () {
          const r = await orig.apply(this, arguments);
          setTimeout(adjustTradingLayout, 700);
          setTimeout(adjustTradingLayout, 1500);
          return r;
        };
      }
    })();
  </script>
  <script>
    (function(){
      const KEY = 'dashboardBgSettings_v1';
      const bg = document.getElementById('bg');
      const overlay = document.getElementById('bg-overlay');
      const btn = document.getElementById('bgBtn');
      const panel = document.getElementById('bgPanel');
      const fileInput = document.getElementById('bgFile');
      const urlInput = document.getElementById('bgUrl');
      const useUrlBtn = document.getElementById('bgUseUrl');
      const saveBtn = document.getElementById('bgSave');
      const clearBtn = document.getElementById('bgClear');
      const sizeSel = document.getElementById('bgSize');
      const posSel = document.getElementById('bgPos');
      const blurRange = document.getElementById('bgBlur');
      const darkRange = document.getElementById('bgDark');
      function loadSettings(){
        try {
          const raw = localStorage.getItem(KEY);
          if (!raw) return null;
          return JSON.parse(raw);
        } catch(e){ return null; }
      }
      function saveSettings(s){
        localStorage.setItem(KEY, JSON.stringify(s));
      }
      function applySettings(s){
        if (!s) {
          bg.style.backgroundImage = '';
          bg.style.backgroundSize = 'cover';
          bg.style.backgroundPosition = 'center center';
          bg.style.filter = '';
          overlay.style.background = 'rgba(0,0,0,0.25)';
          return;
        }
        if (s.dataUrl) bg.style.backgroundImage = `url("${s.dataUrl}")`;
        else if (s.url) bg.style.backgroundImage = `url("${s.url}")`;
        else bg.style.backgroundImage = '';
        bg.style.backgroundSize = s.size || 'cover';
        bg.style.backgroundPosition = s.position || 'center center';
        bg.style.filter = `blur(${(s.blur||0)}px)`;
        overlay.style.background = `rgba(0,0,0,${(s.dark||0)})`;
        // make sure panels and content remain readable
      }
      // initialize UI from saved settings
      const settings = loadSettings() || {};
      if (settings.size) sizeSel.value = settings.size;
      if (settings.position) posSel.value = settings.position;
      if (typeof settings.blur !== 'undefined') blurRange.value = settings.blur;
      if (typeof settings.dark !== 'undefined') darkRange.value = settings.dark;
      if (settings.url) urlInput.value = settings.url;
      applySettings(settings);
      // toggle panel
      btn.addEventListener('click', ()=> {
        const open = panel.classList.toggle('open');
        panel.setAttribute('aria-hidden', !open);
      });
      // file chosen -> read as dataURL and preview immediately (and save only on Save)
      let tempSettings = Object.assign({}, settings);
      fileInput.addEventListener('change', e=>{
        const f = e.target.files && e.target.files[0];
        if (!f) return;
        const reader = new FileReader();
        reader.onload = () => {
          tempSettings.dataUrl = reader.result;
          tempSettings.url = undefined;
          applySettings(tempSettings);
        };
        reader.readAsDataURL(f);
      });
      useUrlBtn.addEventListener('click', ()=>{
        const u = urlInput.value && urlInput.value.trim();
        if (!u) return;
        tempSettings.url = u;
        tempSettings.dataUrl = undefined;
        applySettings(tempSettings);
      });
      // live update controls
      [sizeSel,posSel,blurRange,darkRange].forEach(el=>{
        el.addEventListener('input', ()=>{
          tempSettings.size = sizeSel.value;
          tempSettings.position = posSel.value;
          tempSettings.blur = Number(blurRange.value);
          tempSettings.dark = Number(darkRange.value);
          applySettings(tempSettings);
        });
      });
      // Save final settings
      saveBtn.addEventListener('click', ()=>{
        tempSettings.size = sizeSel.value;
        tempSettings.position = posSel.value;
        tempSettings.blur = Number(blurRange.value);
        tempSettings.dark = Number(darkRange.value);
        saveSettings(tempSettings);
        // also update settings variable
        // give visual feedback
        saveBtn.textContent = 'Saved';
        setTimeout(()=> saveBtn.textContent = 'Save', 900);
      });
      clearBtn.addEventListener('click', ()=> {
        tempSettings = {};
        fileInput.value = '';
        urlInput.value = '';
        sizeSel.value = 'cover';
        posSel.value = 'center center';
        blurRange.value = 4;
        darkRange.value = 0.25;
        applySettings(tempSettings);
        saveSettings(tempSettings);
      });
      // allow closing panel by clicking outside
      document.addEventListener('click', (e) => {
        if (!panel.contains(e.target) && !btn.contains(e.target)) {
          panel.classList.remove('open');
          panel.setAttribute('aria-hidden', 'true');
        }
      });
    })();
  </script>
  <script>
    (function() {
      // locate badges once
      const silverBadge = (function ensureLocalUpdateBadge(id) {
        const el = document.getElementById(id);
        if (!el) return null;
        let badge = el.querySelector('.local-update');
        if (!badge) {
          badge = document.createElement('div');
          badge.className = 'local-update';
          badge.textContent = 'Cập nhật: -';
          const cs = window.getComputedStyle(el);
          if (cs.position === 'static') el.style.position = 'relative';
          el.appendChild(badge);
        }
        return badge;
      })('card-silver-phuquy');
      const exchangeBadge = (function ensureLocalUpdateBadge(id) {
        const el = document.getElementById(id);
        if (!el) return null;
        let badge = el.querySelector('.local-update');
        if (!badge) {
          badge = document.createElement('div');
          badge.className = 'local-update';
          badge.textContent = 'Cập nhật: -';
          const cs = window.getComputedStyle(el);
          if (cs.position === 'static') el.style.position = 'relative';
          el.appendChild(badge);
        }
        return badge;
      })('card-exchange-vcb');
      // fetch phuquy silver update via server proxy
      async function fetchPhuquySilverTime() {
        try {
          const res = await fetch('http://localhost:3000/phuquy-silver');
          if (!res.ok) throw new Error('phuquy proxy failed ' + res.status);
          const j = await res.json();
          if (j && j.success && j.time) return j.time;
        } catch (e) {
          console.warn('fetchPhuquySilverTime error', e && e.message);
        }
        return null;
      }
      // patch fetchRealUpdate to update badges as requested:
      const origFetch = window.fetchRealUpdate;
      if (typeof origFetch === 'function') {
        window.fetchRealUpdate = async function() {
          const data = await origFetch.apply(this, arguments);
          try {
            // exchange time: use scrape time from server response (if present)
            const exchTime = data && data.exchange && (data.exchange.update_time_scraped || data.exchange.update_time) ? (data.exchange.update_time_scraped || data.exchange.update_time) : null;
            if (exchangeBadge) exchangeBadge.textContent = 'Cập nhật: ' + (exchTime || '-');
            // silver time: prefer phuquy site parsed value (via server), fallback to server payload scrape time
            const phuTime = await fetchPhuquySilverTime();
            const silverTimeFallback = data && data.silver && (data.silver.update_time_scraped || data.silver.update_time) ? (data.silver.update_time_scraped || data.silver.update_time) : null;
            if (silverBadge) silverBadge.textContent = 'Cập nhật: ' + (phuTime || silverTimeFallback || '-');
          } catch (e) {
            console.warn('badge update error', e && e.message);
          }
          return data;
        };
      } else {
        // if fetchRealUpdate not defined yet, periodically update badges from lastScrapeData or via phuquy endpoint
        setInterval(async () => {
          try {
            const data = window.lastScrapeData || null;
            const exchTime = data && data.exchange && (data.exchange.update_time_scraped || data.exchange.update_time) ? (data.exchange.update_time_scraped || data.exchange.update_time) : null;
            if (exchangeBadge && exchTime) exchangeBadge.textContent = 'Cập nhật: ' + exchTime;
            const phuTime = await fetchPhuquySilverTime();
            const silverTimeFallback = data && data.silver && (data.silver.update_time_scraped || data.silver.update_time) ? (data.silver.update_time_scraped || data.silver.update_time) : null;
            if (silverBadge) silverBadge.textContent = 'Cập nhật: ' + (phuTime || silverTimeFallback || '-');
          } catch (e) {}
        }, 15000);
      }
    })();
  </script>
  <!-- add movable/resizable gold-compare widget (injected if missing) -->
  <script>
(function(){
  const WID = 'gold-compare';
  if (document.getElementById(WID)) return; // already present

  // create widget
  const w = document.createElement('div');
  w.id = WID;
  w.innerHTML = `
    <div class="gc-hdr">QUY ĐỔI GIÁ VÀNG THẾ GIỚI ↔ TRONG NƯỚC <button id="gc-hide" title="Ẩn" style="float:right">✕</button></div>
    <div class="gc-body">
      <table style="width:100%;border-collapse:collapse">
        <thead>
          <tr>
            <th style="text-align:left;font-weight:700;color:#000">Giá vàng thế giới[XAUUSD]<br><span style="font-weight:600;font-size:14px;color:#444">(USD / Ounce)</span></th>
            <th style="text-align:left;font-weight:700;color:#000">Tỷ giá<br><span style="font-weight:600;font-size:14px;color:#444">(VND / 1 USD)</span></th>
            <th style="text-align:left;font-weight:700;color:#000">Giá vàng thế giới quy đổi [XAUUSD]<br><span style="font-weight:600;font-size:14px;color:#444">(Triệu / Lượng)</span></th>
            <th style="text-align:left;font-weight:700;color:#000">Chênh lệch Vàng.miếng.SJC-[XAUUSD]<br><span style="font-weight:600;font-size:14px;color:#444">(Triệu / Lượng)</span></th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td id="gc-world" class="gc-num" style="font-weight:700;font-size:19.5px;line-height:1;color:#003399">—</td>
            <td id="gc-fx"    class="gc-num" style="font-weight:700;font-size:19.5px;line-height:1;color:#003399">—</td>
            <td id="gc-conv"  class="gc-num" style="font-weight:700;font-size:19.5px;line-height:1;color:#003399">—</td>
            <td id="gc-diff"  class="gc-num" style="font-weight:700;font-size:19.5px;line-height:1;color:#FF8C00">—</td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="gc-notes" style="margin-top:8px;color:#000000;font-size:13px;line-height:1.3">
      <div class="gc-note-line"> Giá vàng trong nước(VND/Lượng) = (Giá vàng thế giới(USD/oz) ÷ 0.82945) × Tỷ giá (VND/USD).</div>
      <div class="gc-note-line" style="margin-top:4px">Giá so sánh: Giá bán ra vàng miếng SJC (Triệu đồng/Lượng)</div>
      <div class="gc-note-line" style="margin-top:4px">[XAUUSD] update from https://goldprice.org/</div>
    </div>
  `;





  // base styles (non-invasive)
  Object.assign(w.style, {
    position: 'fixed',
    right: '10px',
    top: '700px',
    background: '#fff',
    border: '3px solid #FF6600',
    borderRadius: '8px',
    padding: '6px',
    boxShadow: '0 6px 18px rgba(0,0,0,0.08)',
    zIndex: 13000,
    resize: 'none', // both
    overflow: 'auto',
    minWidth: '630px',
    minHeight: '230px',
    boxSizing: 'border-box'
  });
  // hdr style
  const hdr = w.querySelector('.gc-hdr');
  Object.assign(hdr.style, { cursor:'move', padding:'4px 6px', color:'#000', fontWeight:700, userSelect:'none' });
  document.body.appendChild(w);

  // restore saved pos/size
  const POS_KEY = 'goldCompare_pos_v1';
  const SIZE_KEY = 'goldCompare_size_v1';
  try {
    const pos = JSON.parse(localStorage.getItem(POS_KEY) || 'null');
    const sz = JSON.parse(localStorage.getItem(SIZE_KEY) || 'null');
    if (pos && typeof pos.left === 'number') {
      w.style.left = pos.left + 'px';
      w.style.top = pos.top + 'px';
      w.style.right = 'auto';
      w.style.position = 'fixed';
    }
    if (sz && sz.width) {
      w.style.width = sz.width + 'px';
      if (sz.height) w.style.height = sz.height + 'px';
    }
  } catch(e){}

  // match position/size to exchange card if user hasn't set size/pos
  function matchToExchangeIfNeeded(){
    try {
      // If user already set size or position, don't override
      if (localStorage.getItem(SIZE_KEY) || localStorage.getItem(POS_KEY)) return;
      const ex = document.getElementById('card-exchange-vcb');
      if (!ex) return;
      const r = ex.getBoundingClientRect();
      // place widget directly below the exchange card with 6px gap
      const gap = 6;
      const left = Math.round(r.left + window.scrollX);
      const top = Math.round(r.bottom + gap + window.scrollY);
      w.style.left = left + 'px';
      w.style.top = top + 'px';
      w.style.right = 'auto';
      w.style.position = 'fixed';
      // match width, set a sensible height (at least 120px)
      w.style.width = Math.round(r.width) + 'px';
      w.style.height = Math.max(120, Math.round(r.height)) + 'px';
    } catch(e){}
  }
  matchToExchangeIfNeeded();
  window.addEventListener('resize', () => setTimeout(matchToExchangeIfNeeded, 120));

  // drag
  let dragging=false, sx=0, sy=0, ox=0, oy=0;
  hdr.addEventListener('pointerdown', (e)=>{
    dragging = true;
    hdr.setPointerCapture(e.pointerId);
    sx = e.clientX; sy = e.clientY;
    ox = w.offsetLeft; oy = w.offsetTop;
    function move(ev){
      if (!dragging) return;
      const nx = Math.max(6, Math.round(ox + (ev.clientX - sx)));
      const ny = Math.max(6, Math.round(oy + (ev.clientY - sy)));
      w.style.left = nx + 'px';
      w.style.top = ny + 'px';
      w.style.right = 'auto';
      w.style.position = 'fixed';
    }
    function up(ev){
      dragging = false;
      try { localStorage.setItem(POS_KEY, JSON.stringify({ left: w.offsetLeft, top: w.offsetTop })); } catch(e){}
      hdr.releasePointerCapture(e.pointerId);
      window.removeEventListener('pointermove', move);
      window.removeEventListener('pointerup', up);
    }
    window.addEventListener('pointermove', move);
    window.addEventListener('pointerup', up);
  });

  // persist resize using ResizeObserver
  try {
    const ro = new ResizeObserver(entries => {
      const r = entries[0].contentRect;
      try { localStorage.setItem(SIZE_KEY, JSON.stringify({ width: Math.round(r.width), height: Math.round(r.height) })); } catch(e){}
    });
    ro.observe(w);
  } catch(e){}

  // hide button
  w.querySelector('#gc-hide').addEventListener('click', ()=>{
    w.style.display = 'none';
    // show small show button
    if (!document.getElementById('gc-show-btn')) {
      const b = document.createElement('button');
      b.id = 'gc-show-btn';
      b.textContent = 'So sánh Vàng';
      Object.assign(b.style, { position:'fixed', left:'12px', bottom:'12px', zIndex:13000, padding:'8px', borderRadius:'6px', background:'#fff', border:'1px solid #ddd', cursor:'pointer' });
      b.onclick = () => { w.style.display='block'; b.remove(); matchToExchangeIfNeeded(); };
      document.body.appendChild(b);
    }
  });

  // expose small API so existing updater can target ids #gc-world, #gc-fx, #gc-conv, #gc-diff
  window.goldCompareWidget = { el: w, matchToExchange: matchToExchangeIfNeeded };
})();
</script>
<script>
/* Updater: nếu /scrape không trả world.xau, gọi public API để lấy giá thế giới */
(function(){
  const SRC = 'http://localhost:3000/scrape';
  const POLL_MS = 60_000;
  const OUNCE_TO_LUONG = 0.82945;

  const $ = id => document.getElementById(id);
  function rawToNumber(raw){
    if (raw == null) return NaN;
    if (typeof raw === 'number') return raw;
    const s = String(raw).trim();
    if (!s || s === '-') return NaN;
    let t = s.replace(/[^\d,.\-]/g,'');
    if (t.indexOf(',')>-1 && t.indexOf('.')>-1){
      if (t.lastIndexOf('.') > t.lastIndexOf(',')) t = t.replace(/,/g,''); else t = t.replace(/\./g,'').replace(/,/g,'.');
    } else t = t.replace(/,/g,'');
    const n = Number(t);
    return Number.isFinite(n) ? n : NaN;
  }
  function parseFx(raw){
    const n = rawToNumber(raw);
    if (!Number.isFinite(n)) return NaN;
    if (n > 0 && n < 1000) return Math.round(n * 1000);
    return Math.round(n);
  }
  function parseSjc(raw){
    const n = rawToNumber(raw);
    if (!Number.isFinite(n)) return NaN;
    if (n > 0 && n < 1000) return Math.round(n * 1_000_000);
    return Math.round(n);
  }
  function fmtMillion(v){ return Number.isFinite(v) ? (v/1e6).toFixed(3)+' triệu' : '—'; }

  async function fetchJson(url){
    try { const r = await fetch(url, {cache:'no-store'}); if (!r.ok) throw 0; return await r.json(); }
    catch(e){ return null; }
  }

  async function fetchWorldDirect(){
    // try metals.live
    try {
      const r = await fetch('https://api.metals.live/v1/spot');
      if (r.ok){
        const j = await r.json();
        if (Array.isArray(j)){
          for (const it of j){
            if (it && typeof it === 'object'){
              if ('xau' in it && Number.isFinite(Number(it.xau))) return Number(it.xau);
              if ('symbol' in it && /XAU/i.test(it.symbol) && Number.isFinite(Number(it.price))) return Number(it.price);
              if ('name' in it && /gold/i.test(it.name) && Number.isFinite(Number(it.price))) return Number(it.price);
            }
          }
        }
      }
    } catch(e){ /* ignore */ }

    // fallback goldprice
    try {
      const r2 = await fetch('https://data-asg.goldprice.org/dbXRates/USD');
      if (r2.ok){
        const j2 = await r2.json();
        const it = j2?.items?.[0];
        if (it && (it.xauPrice || it.xauPriceUsd)) return Number(it.xauPrice || it.xauPriceUsd);
        const r0 = j2?.rates?.find(x => x && /XAU/i.test(x.code));
        if (r0 && r0.rate) return Number(r0.rate);
      }
    } catch(e){}
    return NaN;
  }

  async function updateOnce(){
    const elW = $('gc-world'), elF = $('gc-fx'), elC = $('gc-conv'), elD = $('gc-diff');
    if (!elW || !elF || !elC || !elD) return;

    const data = await fetchJson(SRC) || window.lastScrapeData || null;

    // world may be missing from server payload -> fallback to direct API
    let world = rawToNumber(data?.world?.xau ?? data?.world?.price ?? data?.xau ?? data?.price);
    if (!(Number.isFinite(world) && world > 0)) {
      const w2 = await fetchWorldDirect();
      if (Number.isFinite(w2) && w2 > 0) world = w2;
    }

    let fx = parseFx(data?.exchange?.vcb?.ban_ra ?? data?.exchange?.vcb?.sell ?? data?.exchange?.vcb?.mua ?? data?.exchange?.usd_vnd ?? data?.usd_vnd);
    let sjc = parseSjc(data?.gold?.SJC?.mieng_sell ?? data?.gold?.SJC?.mieng_buy ?? data?.gold?.SJC?.ban_ra ?? data?.gold?.SJC ?? data?.gold?.sjc?.mieng_sell);

    // DOM fallbacks
    if (!(Number.isFinite(fx) && fx>0)){
      const elFxDom = document.querySelector('#card-exchange-vcb td.sell, #exchange-ban-ra, .vcb-sell');
      fx = elFxDom ? parseFx(elFxDom.textContent || elFxDom.innerText) : fx;
    }
    if (!(Number.isFinite(sjc) && sjc>0)){
      const elSjcDom = document.querySelector('#sjc-mieng-sell, .sjc-sell, [data-sjc="sell"]');
      sjc = elSjcDom ? parseSjc(elSjcDom.textContent || elSjcDom.innerText) : sjc;
    }

    const worldOk = Number.isFinite(world) && world>0;
    const fxOk = Number.isFinite(fx) && fx>0;
    const convVnd = (worldOk && fxOk) ? (world / OUNCE_TO_LUONG) * fx : NaN;

    elW.textContent = worldOk ? world.toFixed(2) + ' USD/oz' : '—';
    elF.textContent = fxOk ? Math.round(fx).toLocaleString('en-US') + ' VND' : '—';
    elC.textContent = Number.isFinite(convVnd) ? fmtMillion(convVnd) : '—';

    if (!(Number.isFinite(sjc) && Number.isFinite(convVnd))){
      elD.textContent = '—'; elD.className = 'num';
    } else {
      const diff = sjc - convVnd;
      elD.textContent = (diff/1e6).toFixed(3) + ' triệu';
      elD.className = diff >=0 ? 'num diff-up' : 'num diff-down';
    }

    try { window.lastScrapeData = data || window.lastScrapeData || null; } catch(e){}
  }

  updateOnce();
  setInterval(updateOnce, POLL_MS);
})();
</script>
<!-- Pair-zoom behavior: stacked zoom/clone animation for leftGrid cards -->
<script>
(function(){
  if (window.pairZoom) return; // already installed
  const PAIRS = [
    ['card-sjc','card-pnj'],
    ['card-doji','card-btmc'],
    ['card-btmh','card-mihong'],
    ['card-phuquy','card-ngoctham'],
    ['card-silver-phuquy'],
    ['gold-compare']
  ];
  const FRAME_SELECTOR = '#leftGrid';
  const VISIBLE_MS = 10000;
  const TRANS_MS = 700;
  const GAP_PX = 24;
  let running = false;

  function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

  function ensureOverlay(){
    let o = document.querySelector('.pair-overlay');
    if (!o) { o = document.createElement('div'); o.className = 'pair-overlay'; document.body.appendChild(o); }
    return o;
  }

  function ensureZoomBg(frame){
    let bg = document.querySelector('.zoom-bg');
    if (!bg) { bg = document.createElement('div'); bg.className = 'zoom-bg'; document.body.appendChild(bg); }
    try { const r = (frame && frame.getBoundingClientRect) ? frame.getBoundingClientRect() : (document.querySelector(FRAME_SELECTOR) || document.getElementById('leftGrid')).getBoundingClientRect(); bg.style.left = Math.round(r.left) + 'px'; bg.style.top = Math.round(r.top) + 'px'; bg.style.width = Math.round(r.width) + 'px'; bg.style.height = Math.round(r.height) + 'px'; } catch(e){ bg.style.left='0'; bg.style.top='0'; bg.style.width='40vw'; bg.style.height='80vh'; }
    bg.classList.remove('hidden');
    return bg;
  }

  function hideZoomBg(){ const bg = document.querySelector('.zoom-bg'); if (bg) bg.classList.add('hidden'); }

  function setOverlayToFrame(overlay, frame){ const r = frame.getBoundingClientRect(); overlay.style.left = r.left + 'px'; overlay.style.top = r.top + 'px'; overlay.style.width = r.width + 'px'; overlay.style.height = r.height + 'px'; overlay.style.pointerEvents = 'none'; }

  function stripIds(node){ if (!node || node.nodeType !== 1) return; node.removeAttribute('id'); for (let i=0;i<node.children.length;i++) stripIds(node.children[i]); }

  function createClone(el, overlay){ const r = el.getBoundingClientRect(); const o = overlay.getBoundingClientRect(); const clone = el.cloneNode(true); stripIds(clone); clone.className = (clone.className ? clone.className + ' ' : '') + 'zoom-clone'; clone.style.width = Math.round(r.width) + 'px'; clone.style.height = Math.round(r.height) + 'px'; clone.style.left = Math.round(r.left - o.left) + 'px'; clone.style.top = Math.round(r.top - o.top) + 'px'; clone.style.margin = '0'; clone.style.opacity = '1'; overlay.appendChild(clone); return clone; }

  function hideAllExcept(keepIds = [], frame) { const container = frame || document.querySelector(FRAME_SELECTOR) || document.getElementById('leftGrid'); if (!container) return; const cards = Array.from(container.querySelectorAll('.card, #gold-compare')); cards.forEach(c => { if (!c.id) return; if (keepIds.includes(c.id)) c.classList.remove('zoom-hidden'); else c.classList.add('zoom-hidden'); }); }
  function restoreAllVisibility() { const cards = Array.from(document.querySelectorAll('.card.zoom-hidden')); cards.forEach(c => { c.classList.remove('zoom-hidden'); }); }

  async function showStackedPair(pairIds, overlay, frame) {
    setOverlayToFrame(overlay, frame);
    const originals = pairIds.map(id => document.getElementById(id)).filter(Boolean);
    if (!originals.length) return;
    const clones = originals.map(el => createClone(el, overlay));
    const zoomBg = ensureZoomBg(frame);
    hideAllExcept(pairIds, frame);
    await sleep(30);
    const oRect = overlay.getBoundingClientRect();
    const rects = clones.map(c => c.getBoundingClientRect());
    const h0 = rects[0] ? rects[0].height : 0; const h1 = rects[1] ? rects[1].height : 0; const preferScale = 2; const maxAllowed = Math.max(1, oRect.height * 0.9 - GAP_PX); const scale = Math.min(preferScale, maxAllowed / Math.max(1, (h0 + h1)));
    let targetBottom = oRect.height - 8; const isSingle = clones.length === 1;
    if (isSingle && pairIds[0] === 'card-silver-phuquy') {
      const tradingEl = document.getElementById('tv-box') || document.querySelector('.chart-box') || document.getElementById('tradingview_chart');
      if (tradingEl) { try { const tRect = tradingEl.getBoundingClientRect(); const tbRel = Math.round(tRect.bottom - oRect.top); if (tbRel > 0 && tbRel <= oRect.height) targetBottom = Math.min(tbRel, oRect.height - 8); } catch(e){} }
      const SILVER_EXTRA_UP_PX = 500; targetBottom = Math.max(0, targetBottom - SILVER_EXTRA_UP_PX);
    } else if (isSingle && pairIds[0] === 'gold-compare') {
      // Position the gold-compare clone near the exchange card so it zooms out in a similar place
      const exchangeEl = document.getElementById('card-exchange-vcb');
      if (exchangeEl) {
        try {
          const exchRect = exchangeEl.getBoundingClientRect();
          const exchBottomRel = Math.round(exchRect.bottom - oRect.top);
          if (exchBottomRel > 0 && exchBottomRel <= oRect.height) targetBottom = Math.min(exchBottomRel, oRect.height - 8);
        } catch(e){}
      }
    } else {
      const exchangeEl = document.getElementById('card-exchange-vcb'); if (exchangeEl) { const exchRect = exchangeEl.getBoundingClientRect(); const exchBottomRel = Math.round(exchRect.bottom - oRect.top); if (exchBottomRel > 0 && exchBottomRel <= oRect.height) targetBottom = Math.min(exchBottomRel, oRect.height - 8); }
    }
    const centerX = Math.round(oRect.width / 2);
    if (clones.length === 1) {
      const totalH = h0 * scale; let topOfStack = Math.round(targetBottom - totalH); if (topOfStack < 0) topOfStack = 0; const c_centerY = topOfStack + Math.round((h0 * scale) / 2); const c = clones[0]; const r = c.getBoundingClientRect(); const curCx = Math.round(r.left + r.width / 2) - oRect.left; const curCy = Math.round(r.top + r.height / 2) - oRect.top; const dx = centerX - curCx; const dy = c_centerY - curCy; c.style.transition = `transform ${TRANS_MS}ms cubic-bezier(.22,.9,.28,1), opacity 300ms ease`; c.style.transform = `translate(${dx}px, ${dy}px) scale(${scale})`; c.style.zIndex = '31000';
    } else {
      const totalStackHeight = (h0 + h1) * scale + GAP_PX; let topOfStack = Math.round(targetBottom - totalStackHeight); if (topOfStack < 0) topOfStack = 0; const c0_centerY = topOfStack + Math.round(h0 * scale / 2); const c1_centerY = topOfStack + Math.round(h0 * scale) + GAP_PX + Math.round(h1 * scale / 2); clones.forEach((c, idx) => { const r = c.getBoundingClientRect(); const curCx = Math.round(r.left + r.width / 2) - oRect.left; const curCy = Math.round(r.top + r.height / 2) - oRect.top; const targetCy = idx === 0 ? c0_centerY : c1_centerY; const dx = centerX - curCx; const dy = targetCy - curCy; c.style.transition = `transform ${TRANS_MS}ms cubic-bezier(.22,.9,.28,1), opacity 300ms ease`; c.style.transform = `translate(${dx}px, ${dy}px) scale(${scale})`; c.style.zIndex = '31000'; });
    }
    overlay.style.pointerEvents = 'auto';
    const start = Date.now(); while (Date.now() - start < VISIBLE_MS) { await sleep(200); }
    clones.forEach(c => { c.style.opacity = '0'; c.style.transform += ' translateY(8px)'; }); await sleep(Math.max(220, TRANS_MS)); clones.forEach(c => c.remove()); restoreAllVisibility(); hideZoomBg(); overlay.style.pointerEvents = 'none';
  }

  async function runAllPairs() { if (running) return; running = true; const frame = document.querySelector(FRAME_SELECTOR) || document.querySelector('.left') || document.getElementById('leftGrid'); if (!frame) { running = false; return; } const overlay = ensureOverlay(); for (const p of PAIRS) { try { await showStackedPair(p, overlay, frame); await sleep(300); } catch (e) { console.warn('pair zoom error', e && e.message); } } overlay.style.width = '0'; overlay.style.height = '0'; running = false; }

  window.pairZoom = { run: runAllPairs, isRunning: () => running };
  window.addEventListener('load', () => { setTimeout(() => { try { runAllPairs(); } catch(e) {} }, 65000); setInterval(() => { try { runAllPairs(); } catch(e) {} }, 60000); });
  function addDebugBtn(){ if (document.getElementById('debug-zoom-btn')) return; const btn = document.createElement('button'); btn.id = 'debug-zoom-btn'; btn.textContent = '*'; Object.assign(btn.style, { position:'fixed', right:'12px', bottom:'12px', zIndex:32000, padding:'8px 10px', borderRadius:'6px', background:'#111', color:'#fff', border:'none', opacity:0.9 }); btn.onclick = async ()=> { try { await runAllPairs(); } catch(e){ console.warn(e); } }; document.body.appendChild(btn); }
  if (document.readyState === 'complete' || document.readyState === 'interactive') addDebugBtn(); else document.addEventListener('DOMContentLoaded', addDebugBtn);
})();
</script>
<!-- Ticker bar mới cho VN Index và Crypto - Không thay đổi code hiện có -->
<style>
    #ticker-container, .ticker { display: none !important; }
    #ticker-container-new {
        position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background-color: #343326;
        color: rgb(118, 221, 255); overflow: hidden; z-index: 1001; border-top: 2px solid #343326;
        display: flex; align-items: center;
    }
    #ticker-wrapper-new {
        display: flex; white-space: nowrap; animation: scroll-ltr-new 120s linear infinite;
    }
    #ticker-wrapper-new:hover { animation-play-state: paused; }
    @keyframes scroll-ltr-new { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
    .ticker-item-new {
        display: inline-flex; align-items: center; padding: 0 30px; min-width: 280px; border-right: 1px solid #555;
    }
    .symbol-new { font-weight: bold; font-size: 26px; margin-right: 12px; }
    .value-new { font-size: 30px; line-height: 60px; font-weight: bold; }
    .positive-new { color: #6fff6f; }
    .negative-new { color: #ff7472; }
    #update-time-new { position: absolute; top: 5px; right: 10px; font-size: 14px; color: #ccc; font-weight: bold; }
    #error-new { color: red; text-align: center; display: none; font-size: 14px; font-weight: bold; }
</style>

<div id="ticker-container-new">
    <div id="update-time-new">Cập nhật: <span id="timestamp-new"></span></div>
    <div id="ticker-wrapper-new"></div>
    <div id="error-new"></div>
</div>

<script>
    const itemsNew = ['VN-Index', 'HNX-Index', 'UPCoM-Index', 'VN30', 'BTC-USD', 'ETH-USD', 'BNB-USD', 'XRP-USD'];

    // Khởi tạo base text
    function initTicker() {
        const wrapper = document.getElementById('ticker-wrapper-new');
        wrapper.innerHTML = '';
        itemsNew.forEach(key => {
            const div = document.createElement('div');
            div.className = 'ticker-item-new';
            div.innerHTML = `<span class="symbol-new">${key}</span><span class="value-new">--.-- --.-- (--.--%)</span>`;
            wrapper.appendChild(div);
        });
        document.getElementById('timestamp-new').textContent = new Date().toLocaleString('vi-VN', { timeZone: 'Asia/Ho_Chi_Minh' });
    }

    async function loadDataNew() {
        try {
            // Thêm query param ngẫu nhiên để tránh cache
            const response = await fetch(`data.json?_=${Date.now()}`, { cache: 'no-store' });
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}, StatusText: ${response.statusText}`);
            }
            const data = await response.json();
            console.log('Loaded ticker data:', data);
            document.getElementById('error-new').style.display = 'none';
            return data;
        } catch (e) {
            console.error('Load ticker error:', e.message, e);
            document.getElementById('error-new').textContent = 'Lỗi tải JSON: ' + e.message;
            document.getElementById('error-new').style.display = 'block';
            return null;
        }
    }

    function updateTickerNew(data) {
        if (!data) return;
        const wrapper = document.getElementById('ticker-wrapper-new');
        wrapper.innerHTML = '';
        itemsNew.forEach(key => {
            const item = data[key] || { value: '--.--', change: '--.--', percent: '--.--%', arrow: '' };
            const changeStr = `${item.arrow}${item.change} (${item.percent})`;
            const changeClass = item.percent.includes('+') || item.arrow === '▲' ? 'positive-new' : 'negative-new';
            const div = document.createElement('div');
            div.className = 'ticker-item-new';
            div.innerHTML = `<span class="symbol-new">${key}</span><span class="value-new ${changeClass}">${item.value} ${changeStr}</span>`;
            wrapper.appendChild(div);
        });
        document.getElementById('timestamp-new').textContent = new Date().toLocaleString('vi-VN', { timeZone: 'Asia/Ho_Chi_Minh' });
    }

    async function refreshNew() {
        try {
            const data = await loadDataNew();
            updateTickerNew(data);
        } catch (e) {
            console.error('refreshNew error:', e.message, e);
        }
    }

    // Wrap setInterval trong hàm để theo dõi trạng thái
    function startTickerRefresh() {
        initTicker(); // Khởi tạo base text ngay lập tức
        refreshNew(); // Lần đầu
        const intervalId = setInterval(() => {
            console.log('Ticker refresh attempt at', new Date().toLocaleString('vi-VN', { timeZone: 'Asia/Ho_Chi_Minh' }));
            refreshNew();
        }, 5000);
        // Log khi interval dừng (nếu có)
        window.addEventListener('unload', () => {
            console.log('Ticker refresh interval stopped');
            clearInterval(intervalId);
        });
    }

    // Bắt lỗi toàn cục để debug
    window.addEventListener('error', (event) => {
        console.error('Global error:', event.message, event.error);
        document.getElementById('error-new').textContent = 'Lỗi JavaScript: ' + event.message;
        document.getElementById('error-new').style.display = 'block';
    });

    startTickerRefresh();
</script>
<!-- Kết thúc chương trình con ticker -->
</body>
</html>